# 告警规则系统使用指南

## 📋 概述

告警规则系统允许用户自定义监控规则和告警阈值，支持多种通知方式（邮件、Webhook），实现灵活的告警管理。

## ✨ 核心功能

### 1. 动态规则配置
- ✅ 自定义监控指标（CPU、内存、磁盘、网络）
- ✅ 灵活的阈值条件（>、≥、<、≤、=）
- ✅ 多级告警级别（信息、警告、错误、严重）
- ✅ 全局规则 vs 服务器特定规则

### 2. 智能告警策略
- ✅ 持续时间检测（避免瞬时波动）
- ✅ 告警静默期（防止重复告警）
- ✅ 自动触发和恢复

### 3. 多渠道通知
- ✅ 邮件通知（支持多收件人）
- ✅ Webhook通知（集成第三方系统）
- ✅ 通知记录和重试机制

### 4. 统计与分析
- ✅ 实时告警统计
- ✅ 历史趋势分析
- ✅ 按类型/服务器分组

## 🚀 快速开始

### 创建第一个告警规则

#### 1. 访问告警规则管理
登录系统 → 左侧菜单 → **告警规则**

#### 2. 创建规则
点击 **创建规则** 按钮，填写以下信息：

**基础配置**
- **规则名称**: `CPU使用率过高告警`
- **规则描述**: `当CPU使用率超过80%时触发告警`
- **应用范围**: 选择特定服务器或选择"全局规则"
- **监控指标**: `CPU使用率`
- **阈值条件**: `大于 (>)` `80` `%`
- **告警级别**: `警告`
- **持续时间**: `60` 秒（连续60秒超过阈值才触发）
- **静默期**: `300` 秒（触发后5分钟内不再重复告警）

**通知配置**
- **邮件通知**: 开启
- **收件人**: 输入邮箱地址，支持多个
- **Webhook通知**: 可选

#### 3. 保存并启用
点击 **创建** 按钮，规则立即生效。

## 📖 详细功能说明

### 监控指标类型

| 指标类型 | 说明 | 单位 |
|---------|------|------|
| CPU | CPU使用率 | % |
| Memory | 内存使用率 | % |
| Disk | 磁盘使用率 | % |
| Network | 网络流量 | Mbps |

### 阈值操作符

| 操作符 | 符号 | 说明 |
|-------|------|------|
| gt | > | 大于 |
| gte | ≥ | 大于等于 |
| lt | < | 小于 |
| lte | ≤ | 小于等于 |
| eq | = | 等于 |

### 告警级别

| 级别 | 说明 | 使用场景 |
|------|------|---------|
| info | 信息 | 一般性提示，无需立即处理 |
| warning | 警告 | 需要关注，但暂时不影响服务 |
| error | 错误 | 需要尽快处理 |
| critical | 严重 | 需要立即处理，可能导致服务中断 |

## 🔔 通知配置

### 邮件通知

#### 配置步骤
1. 在规则编辑页面开启"邮件通知"
2. 添加收件人邮箱（可多个）
3. 保存规则

#### 邮件模板
系统会发送包含以下信息的HTML邮件：
- 告警标题
- 告警级别
- 告警类型
- 当前值/阈值
- 触发时间
- 详细信息

#### SMTP 配置
需要在后端配置 SMTP 服务器（参见部署文档）。

### Webhook 通知

#### 使用场景
- 集成到 Slack、钉钉、企业微信等
- 触发自动化工作流
- 对接第三方监控系统

#### Webhook Payload 格式
```json
{
  "alert_id": 123,
  "server_id": 1,
  "title": "CPU使用率过高",
  "message": "CPU使用率达到 85.5%，超过阈值 80.0%",
  "alert_type": "cpu",
  "level": "warning",
  "current_value": 85.5,
  "threshold_value": 80.0,
  "status": "open",
  "triggered_at": "2025-01-15T10:30:00",
  "timestamp": "2025-01-15T10:30:00"
}
```

#### 测试Webhook
在规则编辑页面的"通知配置"标签页，点击"发送测试消息"按钮。

## 📊 告警统计

### 实时统计
在"告警管理"页面可以看到：
- 总告警数
- 待处理告警
- 严重告警数
- 已解决告警

### 趋势分析
- 最近7天的告警趋势图
- 按级别分类的堆叠折线图
- 支持自定义时间范围

### 分组统计
- 按告警类型分组
- 按服务器分组
- 导出统计报表（未来功能）

## 🎯 最佳实践

### 1. 规则设计原则

**❌ 不推荐**
```
规则名称: 告警1
阈值: CPU > 50%
静默期: 0秒
```

**✅ 推荐**
```
规则名称: 生产服务器-CPU高负载告警
阈值: CPU > 80%（持续60秒）
静默期: 300秒
告警级别: warning（>90%升级为critical）
```

### 2. 分级告警策略

```
CPU使用率:
- 70-80%: info级别，仅记录
- 80-90%: warning级别，邮件通知
- 90-95%: error级别，邮件+Webhook
- >95%: critical级别，立即通知所有渠道
```

### 3. 避免告警风暴

```
✅ 设置合理的静默期（推荐5-10分钟）
✅ 使用持续时间过滤瞬时波动
✅ 针对不同服务器设置不同阈值
❌ 不要将所有规则设置为critical级别
❌ 避免静默期过短导致重复通知
```

### 4. 规则组织

```
全局规则（应用于所有服务器）:
- 基础资源监控（CPU > 90%, Memory > 90%）
- 磁盘空间告警（Disk > 85%）

特定服务器规则:
- 数据库服务器: 内存 > 80% 即告警
- Web服务器: CPU持续5分钟 > 75% 告警
- 缓存服务器: 内存 > 70% 告警
```

## 🔧 API 使用

### 创建告警规则
```bash
POST /api/alert-rules
Content-Type: application/json

{
  "name": "CPU高负载告警",
  "description": "监控CPU使用率",
  "server_id": 1,
  "metric_type": "cpu",
  "threshold_value": 80.0,
  "threshold_operator": "gt",
  "duration": 60,
  "alert_level": "warning",
  "enable_email": true,
  "email_recipients": ["admin@example.com"],
  "silence_duration": 300,
  "is_active": true
}
```

### 获取告警统计
```bash
GET /api/alert-rules/statistics/overview?days=7
```

### 获取告警趋势
```bash
GET /api/alert-rules/statistics/trends?days=7
```

## 🐛 故障排除

### 告警未触发

**检查项：**
1. ✅ 规则是否启用（is_active = true）
2. ✅ 服务器是否在监控中
3. ✅ 阈值设置是否合理
4. ✅ 持续时间是否过长
5. ✅ 是否在静默期内

### 通知未发送

**邮件通知：**
1. ✅ 检查 SMTP 配置
2. ✅ 查看通知记录（status字段）
3. ✅ 检查邮箱地址格式

**Webhook通知：**
1. ✅ URL是否可访问
2. ✅ 使用"测试Webhook"功能
3. ✅ 检查目标服务器日志
4. ✅ 查看error_message字段

### 告警过多

**解决方案：**
1. 调整阈值（提高触发条件）
2. 增加持续时间（过滤瞬时波动）
3. 延长静默期（减少重复告警）
4. 禁用不必要的规则

## 📚 相关文档

- [API 文档](./API_DOCUMENTATION.md) - 完整的API接口说明
- [部署指南](./DEPLOYMENT.md) - SMTP配置和部署说明
- [用户手册](./USER_MANUAL.md) - 系统整体使用指南

## 🎓 示例场景

### 场景1：生产环境监控

```yaml
规则1: 严重CPU告警
  - 监控指标: CPU
  - 阈值: > 95%
  - 持续: 120秒
  - 级别: critical
  - 通知: 邮件 + Webhook（钉钉）
  - 静默: 600秒

规则2: CPU预警
  - 监控指标: CPU
  - 阈值: > 80%
  - 持续: 300秒
  - 级别: warning
  - 通知: 仅邮件
  - 静默: 1800秒
```

### 场景2：磁盘空间监控

```yaml
规则: 磁盘空间不足
  - 监控指标: Disk
  - 阈值: > 85%
  - 持续: 0秒（立即触发）
  - 级别: error
  - 通知: 邮件
  - 静默: 3600秒（1小时）
```

### 场景3：内存泄漏检测

```yaml
规则: 内存持续增长
  - 监控指标: Memory
  - 阈值: > 85%
  - 持续: 600秒（10分钟）
  - 级别: error
  - 通知: 邮件 + Webhook
  - 静默: 1800秒
```

## 💡 高级技巧

### 1. 分时段告警
未来版本将支持：
- 工作时间：更严格的阈值
- 非工作时间：更宽松的阈值

### 2. 告警聚合
未来版本将支持：
- 相同服务器的多个告警聚合通知
- 批量告警摘要（每小时/每天）

### 3. 自动恢复通知
当监控指标恢复正常时，自动发送恢复通知。

---

**更新时间**: 2025-01-15  
**版本**: v2.0  
**作者**: 运维自动化平台团队

